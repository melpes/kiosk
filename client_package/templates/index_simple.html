<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ìŒì„± í´ë¼ì´ì–¸íŠ¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            gap: 20px;
        }
        
        .container {
            flex: 1;
            max-width: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            transition: transform 0.3s ease;
            transform: translateX(100%);
        }
        
        .sidebar.collapsed {
            transform: translateX(100%);
        }
        
        .sidebar:not(.collapsed) {
            transform: translateX(0);
        }
        
        .sidebar-header {
            background: #e74c3c;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .sidebar-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 16px;
            padding: 8px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sidebar-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .sidebar-content {
            padding: 20px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .menu-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 20px;
            padding: 10px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .menu-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .collapsible-section {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .collapsible-section.collapsed {
            max-height: 0;
            padding: 0 20px;
            border-top: none;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 1px solid #eee;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        
        .section-header:hover {
            background: #e9ecef;
        }
        
        .section-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        
        .section-arrow {
            font-size: 18px;
            transition: transform 0.3s ease;
        }
        
        .section-arrow.collapsed {
            transform: rotate(-90deg);
        }
        
        .status {
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .controls {
            padding: 20px;
            text-align: center;
        }
        
        .btn {
            padding: 12px 30px;
            margin: 10px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-start {
            background: #28a745;
            color: white;
        }
        
        .btn-start:hover {
            background: #218838;
        }
        
        .btn-stop {
            background: #dc3545;
            color: white;
        }
        
        .btn-stop:hover {
            background: #c82333;
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .config-section {
            padding: 20px;
            border-top: 1px solid #eee;
        }
        
        .config-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .log-section {
            padding: 20px;
            border-top: 1px solid #eee;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .log-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .log-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .log-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .audio-player {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .audio-player audio {
            width: 100%;
            margin-top: 5px;
        }
        
        .order-info {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            margin: 0;
            border-bottom: 3px solid #1e7e34;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .order-info h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            text-align: center;
        }
        
        .order-content {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }
        
        .order-item {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #fff;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .order-item .item-name {
            flex: 1;
        }
        
        .order-item .item-quantity {
            background: rgba(255,255,255,0.3);
            padding: 4px 12px;
            border-radius: 15px;
            margin: 0 10px;
            font-size: 14px;
        }
        
        .order-item .item-price {
            font-weight: bold;
            font-size: 16px;
        }
        
        .order-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .order-total {
            background: rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        /* ì‚¬ì´ë“œë°” ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .sidebar-menu {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .sidebar-menu h3 {
            margin: 0;
            padding: 15px;
            font-size: 16px;
            text-align: center;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
        }
        
        .sidebar-menu-content {
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .sidebar-menu-item {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sidebar-menu-item:hover {
            background: rgba(255,255,255,0.25);
            transform: translateX(3px);
        }
        
        .sidebar-menu-item .item-name {
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .sidebar-menu-item .item-description {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 6px;
        }
        
        .sidebar-menu-item .item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-menu-item .item-category {
            background: rgba(255,255,255,0.3);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
        }
        
        .sidebar-menu-item .item-price {
            font-weight: bold;
            font-size: 14px;
        }
        
        .sidebar-menu-empty {
            padding: 20px;
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-style: italic;
        }
        
        .sidebar-menu-toggle-btn {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 8px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            font-size: 18px;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
        }
        
        .sidebar-menu-toggle-btn:hover {
            background: #c0392b;
            transform: translateY(-50%) translateX(-5px);
        }
        
        .btn-clear {
            background: rgba(220,53,69,0.8);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .btn-clear:hover {
            background: rgba(220,53,69,1);
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- ì‚¬ì´ë“œë°” í† ê¸€ ë²„íŠ¼ -->
    <button class="sidebar-menu-toggle-btn" onclick="toggleSidebar()" title="ë©”ë‰´ ì‚¬ì´ë“œë°” í† ê¸€">
        ğŸ“–
    </button>
    
    <div class="container">
        <div class="header">
            <button class="menu-toggle" onclick="toggleAllSections()" title="ë©”ë‰´ í† ê¸€">
                â˜°
            </button>
            <h1>ğŸ¤ ì‹¤ì‹œê°„ ìŒì„± í´ë¼ì´ì–¸íŠ¸</h1>
            <p>ì›¹ ê¸°ë°˜ ìŒì„± ì¸ì‹ ë° ì‘ë‹µ ì‹œìŠ¤í…œ</p>
        </div>
        
        <div id="order-info" class="order-info" style="display: none;">
            <h3>ğŸ›’ í˜„ì¬ ì£¼ë¬¸ ì •ë³´</h3>
            <div id="order-content">
                <div class="order-item">ì£¼ë¬¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
            <div class="order-meta">
                <span id="order-timestamp">-</span>
                <button onclick="clearOrder()" class="btn-clear">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
            </div>
        </div>
        
        <div id="status" class="status disconnected">
            <span id="status-text">ì—°ê²° ì¤‘...</span>
        </div>
        
        <div class="controls">
            <button id="start-btn" class="btn btn-start" onclick="startSession()">
                ğŸš€ ì„¸ì…˜ ì‹œì‘
            </button>
            <button id="stop-btn" class="btn btn-stop" onclick="stopSession()" disabled>
                â¹ï¸ ì„¸ì…˜ ì¤‘ì§€
            </button>
        </div>
        
        <div class="section-header" onclick="toggleSection('config-section')">
            <h3>âš™ï¸ ì„œë²„ ì„¤ì •</h3>
            <span class="section-arrow">â–¼</span>
        </div>
        <div id="config-section" class="config-section collapsible-section">
            <input type="text" id="server-url" class="config-input" placeholder="ì„œë²„ URL (ì˜ˆ: http://localhost:8001)">
            <button class="btn" onclick="updateConfig()" style="background: #007bff; color: white;">
                ì„¤ì • ì €ì¥
            </button>
            <button class="btn" onclick="testTTS()" style="background: #28a745; color: white;">
                ğŸ”Š TTS í…ŒìŠ¤íŠ¸
            </button>
            <button class="btn" onclick="testOrder()" style="background: #17a2b8; color: white;">
                ğŸ›’ ì£¼ë¬¸ í…ŒìŠ¤íŠ¸
            </button>
        </div>
        
        <div class="section-header" onclick="toggleSection('log-section')">
            <h3>ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
            <span class="section-arrow">â–¼</span>
        </div>
        <div id="log-section" class="log-section collapsible-section">
            <div id="logs"></div>
        </div>
    </div>
    
    <!-- ë©”ë‰´ ì‚¬ì´ë“œë°” -->
    <div id="sidebar" class="sidebar collapsed">
        <div class="sidebar-header">
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="ì‚¬ì´ë“œë°” ë‹«ê¸°">
                âœ•
            </button>
            <h2>ğŸ½ï¸ ì‹ë‹¹ ë©”ë‰´</h2>
            <p>ë§›ìˆëŠ” ìŒì‹ì„ ì„ íƒí•˜ì„¸ìš”</p>
        </div>
        <div class="sidebar-content">
            <div id="sidebar-menu" class="sidebar-menu">
                <h3 id="sidebar-menu-title">ğŸ“‹ ë©”ë‰´</h3>
                <div id="sidebar-menu-content" class="sidebar-menu-content">
                    <div class="sidebar-menu-empty">
                        ì•„ì§ ë©”ë‰´ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>
                        ìŒì„±ìœ¼ë¡œ ë©”ë‰´ë¥¼ ìš”ì²­í•´ë³´ì„¸ìš”!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let isRunning = false;
        
        // ì†Œì¼“ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        socket.on('connect', function() {
            addLog('ì›¹ì†Œì¼“ ì—°ê²°ë¨', 'info');
        });
        
        socket.on('status', function(data) {
            updateStatus(data.message, data.running);
            addLog(data.message, 'info');
        });
        
        socket.on('error', function(data) {
            addLog('âŒ ' + data.message, 'error');
            updateButtons(false);
        });
        
        socket.on('warning', function(data) {
            addLog('âš ï¸ ' + data.message, 'warning');
        });
        
        socket.on('response', function(data) {
            addLog('ğŸ’¬ ì„œë²„ ì‘ë‹µ: ' + data.text, 'info');
            
            // ì£¼ë¬¸ ì •ë³´ ì—…ë°ì´íŠ¸ (nullì¼ ë•Œë„ ì²˜ë¦¬í•˜ì—¬ ì£¼ë¬¸ì°½ ìˆ¨ê¹€)
            if (data.hasOwnProperty('order_data')) {
                updateOrderInfo(data.order_data);
            }
            
            // UI ì•¡ì…˜ ì²˜ë¦¬
            if (data.ui_actions && data.ui_actions.length > 0) {
                processUIActions(data.ui_actions);
            }
        });
        
        socket.on('order_update', function(data) {
            console.log('ì£¼ë¬¸ ì •ë³´ ì—…ë°ì´íŠ¸:', data);
            updateOrderInfo(data);
        });
        
        socket.on('ui_actions', function(data) {
            console.log('ğŸ¯ UI ì•¡ì…˜ ìˆ˜ì‹ :', data);
            processUIActions(data);
        });
        
        socket.on('info', function(data) {
            addLog('â„¹ï¸ ' + data.message, 'info');
        });
        
        socket.on('audio', function(data) {
            console.log('ğŸ”Š TTS ì˜¤ë””ì˜¤ ë°ì´í„° ìˆ˜ì‹ :', data);
            addLog('ğŸ”Š TTS ì˜¤ë””ì˜¤ ìˆ˜ì‹ : ' + (data.filename || data.path), 'info');
            playTTSAudio(data);
        });
        
        // ë©”ë‰´ í† ê¸€ í•¨ìˆ˜ë“¤
        let allSectionsCollapsed = false;
        let sidebarCollapsed = true;
        
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const arrow = section.previousElementSibling.querySelector('.section-arrow');
            
            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                arrow.classList.remove('collapsed');
                arrow.textContent = 'â–¼';
            } else {
                section.classList.add('collapsed');
                arrow.classList.add('collapsed');
                arrow.textContent = 'â–¶';
            }
        }
        
        function toggleAllSections() {
            const sections = ['config-section', 'log-section'];
            const menuToggle = document.querySelector('.menu-toggle');
            
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                const arrow = section.previousElementSibling.querySelector('.section-arrow');
                
                if (allSectionsCollapsed) {
                    section.classList.remove('collapsed');
                    arrow.classList.remove('collapsed');
                    arrow.textContent = 'â–¼';
                } else {
                    section.classList.add('collapsed');
                    arrow.classList.add('collapsed');
                    arrow.textContent = 'â–¶';
                }
            });
            
            allSectionsCollapsed = !allSectionsCollapsed;
            menuToggle.textContent = allSectionsCollapsed ? 'â˜±' : 'â˜°';
        }
        
        // ì‚¬ì´ë“œë°” í† ê¸€ í•¨ìˆ˜
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.querySelector('.sidebar-menu-toggle-btn');
            
            if (sidebarCollapsed) {
                sidebar.classList.remove('collapsed');
                toggleBtn.textContent = 'ğŸ“‹';
                sidebarCollapsed = false;
            } else {
                sidebar.classList.add('collapsed');
                toggleBtn.textContent = 'ğŸ“–';
                sidebarCollapsed = true;
            }
        }
        
        // í•¨ìˆ˜ë“¤
        function startSession() {
            socket.emit('start_session');
            updateButtons(true);
            addLog('ì„¸ì…˜ ì‹œì‘ ìš”ì²­...', 'info');
        }
        
        function stopSession() {
            socket.emit('stop_session');
            updateButtons(false);
            addLog('ì„¸ì…˜ ì¤‘ì§€ ìš”ì²­...', 'info');
        }
        
        function updateStatus(message, running) {
            const statusEl = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            
            statusText.textContent = message;
            isRunning = running;
            
            if (running) {
                statusEl.className = 'status connected';
            } else {
                statusEl.className = 'status disconnected';
            }
            
            updateButtons(running);
        }
        
        function updateButtons(running) {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            
            startBtn.disabled = running;
            stopBtn.disabled = !running;
        }
        
        function addLog(message, type) {
            const logsEl = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            logsEl.appendChild(logEntry);
            logsEl.scrollTop = logsEl.scrollHeight;
            
            // ë¡œê·¸ ê°œìˆ˜ ì œí•œ (ìµœëŒ€ 100ê°œ)
            while (logsEl.children.length > 100) {
                logsEl.removeChild(logsEl.firstChild);
            }
        }
        
        function updateConfig() {
            const serverUrl = document.getElementById('server-url').value;
            if (!serverUrl) {
                addLog('ì„œë²„ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            fetch('/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    server: { url: serverUrl }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
                } else {
                    addLog('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + data.message, 'error');
                }
            })
            .catch(error => {
                addLog('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + error, 'error');
            });
        }
        
        function testTTS() {
            socket.emit('test_tts');
            addLog('ğŸ§ª TTS í…ŒìŠ¤íŠ¸ ìš”ì²­ ì „ì†¡', 'info');
        }
        
        function playTTSAudio(audioData) {
            try {
                console.log('TTS ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œë„:', audioData);
                
                const audioPlayer = document.createElement('div');
                audioPlayer.className = 'audio-player';
                
                const testLabel = audioData.test ? ' (í…ŒìŠ¤íŠ¸)' : '';
                const filename = audioData.filename || audioData.path || 'unknown';
                
                audioPlayer.innerHTML = `
                    <div>ğŸ”Š TTS ìŒì„±${testLabel} (${new Date().toLocaleTimeString()})</div>
                    <div style="font-size: 12px; color: #666;">íŒŒì¼: ${filename}</div>
                    <audio controls preload="auto" style="width: 100%; margin-top: 5px;">
                        <source src="${audioData.url}" type="audio/wav">
                        <source src="${audioData.url}" type="audio/mpeg">
                        <source src="${audioData.url}" type="audio/mp3">
                        ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </audio>
                    <div style="margin-top: 5px;">
                        <button onclick="playAudio(this)" style="padding: 5px 10px;">â–¶ï¸ ì¬ìƒ</button>
                    </div>
                `;
                
                const logsEl = document.getElementById('logs');
                logsEl.appendChild(audioPlayer);
                logsEl.scrollTop = logsEl.scrollHeight;
                
                // ì˜¤ë””ì˜¤ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
                const audio = audioPlayer.querySelector('audio');
                
                // ì˜¤ë””ì˜¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                audio.addEventListener('loadstart', function() {
                    console.log('ì˜¤ë””ì˜¤ ë¡œë“œ ì‹œì‘:', audioData.url);
                });
                
                audio.addEventListener('canplay', function() {
                    console.log('ì˜¤ë””ì˜¤ ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ');
                    addLog('ğŸ”Š TTS ì˜¤ë””ì˜¤ ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ', 'info');
                    
                    // ìë™ ì¬ìƒ ì‹œë„ (í…ŒìŠ¤íŠ¸ê°€ ì•„ë‹Œ ê²½ìš°)
                    if (!audioData.test) {
                        tryAutoPlay(audio);
                    }
                });
                
                audio.addEventListener('error', function(e) {
                    console.error('ì˜¤ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜:', e);
                    console.error('ì˜¤ë””ì˜¤ URL:', audioData.url);
                    console.error('ì˜¤ë””ì˜¤ íŒŒì¼ëª…:', audioData.filename);
                    addLog('âŒ ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨: ' + audioData.filename + ' (' + audioData.url + ')', 'error');
                    
                    // ì˜¤ë¥˜ ìƒì„¸ ì •ë³´ í‘œì‹œ
                    if (audio.error) {
                        const errorCode = audio.error.code;
                        const errorMessage = {
                            1: 'MEDIA_ERR_ABORTED - ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë¨',
                            2: 'MEDIA_ERR_NETWORK - ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜',
                            3: 'MEDIA_ERR_DECODE - ë””ì½”ë”© ì˜¤ë¥˜',
                            4: 'MEDIA_ERR_SRC_NOT_SUPPORTED - ì§€ì›ë˜ì§€ ì•ŠëŠ” í˜•ì‹'
                        };
                        addLog('ì˜¤ë¥˜ ìƒì„¸: ' + (errorMessage[errorCode] || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
                    }
                });
                
                audio.addEventListener('play', function() {
                    addLog('â–¶ï¸ TTS ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œì‘', 'info');
                });
                
                audio.addEventListener('ended', function() {
                    addLog('â¹ï¸ TTS ì˜¤ë””ì˜¤ ì¬ìƒ ì™„ë£Œ', 'info');
                });
                
                // ì˜¤ë””ì˜¤ ë¡œë“œ ì‹œì‘
                audio.load();
                
            } catch (error) {
                console.error('TTS ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:', error);
                addLog('âŒ TTS ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }
        
        function tryAutoPlay(audio) {
            // ìë™ ì¬ìƒ ì‹œë„
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('ìë™ ì¬ìƒ ì„±ê³µ');
                }).catch(error => {
                    console.log('ìë™ ì¬ìƒ ì‹¤íŒ¨ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í•„ìš”):', error);
                    addLog('ğŸ”‡ ìë™ ì¬ìƒ ì‹¤íŒ¨ - ìˆ˜ë™ìœ¼ë¡œ ì¬ìƒ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', 'warning');
                });
            }
        }
        
        function playAudio(button) {
            const audioPlayer = button.closest('.audio-player');
            const audio = audioPlayer.querySelector('audio');
            
            if (audio.paused) {
                audio.play().then(() => {
                    button.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
                }).catch(error => {
                    addLog('ì¬ìƒ ì‹¤íŒ¨: ' + error.message, 'error');
                });
            } else {
                audio.pause();
                button.textContent = 'â–¶ï¸ ì¬ìƒ';
            }
        }
        
        function updateOrderInfo(orderData) {
            try {
                console.log('ì£¼ë¬¸ ì •ë³´ ì—…ë°ì´íŠ¸:', orderData);
                
                const orderInfoEl = document.getElementById('order-info');
                const orderContentEl = document.getElementById('order-content');
                const orderTimestampEl = document.getElementById('order-timestamp');
                
                if (!orderData || !orderData.items || orderData.items.length === 0) {
                    // ì£¼ë¬¸ ì •ë³´ê°€ ì—†ìœ¼ë©´ ìˆ¨ê¸°ê¸°
                    orderInfoEl.style.display = 'none';
                    return;
                }
                
                // ì£¼ë¬¸ í—¤ë” ì •ë³´
                let headerInfo = 'ğŸ›’ í˜„ì¬ ì£¼ë¬¸ ì •ë³´';
                if (orderData.order_id) {
                    headerInfo += ` (ì£¼ë¬¸ë²ˆí˜¸: ${orderData.order_id.substring(0, 8)}...)`;
                }
                if (orderData.status) {
                    const statusEmoji = {
                        'pending': 'â³',
                        'confirmed': 'âœ…',
                        'processing': 'ğŸ”„',
                        'completed': 'âœ…',
                        'cancelled': 'âŒ'
                    };
                    headerInfo += ` ${statusEmoji[orderData.status] || 'ğŸ“‹'} ${orderData.status}`;
                }
                
                document.querySelector('#order-info h3').textContent = headerInfo;
                
                // ì£¼ë¬¸ í•­ëª©ë“¤ í‘œì‹œ
                let orderHtml = '';
                let calculatedTotal = 0;
                
                orderData.items.forEach((item, index) => {
                    const itemTotal = item.price || 0;
                    calculatedTotal += itemTotal;
                    
                    // ì¹´í…Œê³ ë¦¬ í‘œì‹œ
                    const categoryBadge = item.category ? 
                        `<span style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 8px;">${item.category}</span>` : '';
                    
                    orderHtml += `
                        <div class="order-item">
                            <span class="item-name">
                                ${item.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ë©”ë‰´'}
                                ${categoryBadge}
                            </span>
                            <span class="item-quantity">x${item.quantity || 1}</span>
                            <span class="item-price">${formatPrice(itemTotal)}</span>
                        </div>
                    `;
                });
                
                // ì´ ê¸ˆì•¡ í‘œì‹œ (ì„œë²„ì—ì„œ ì˜¨ total_amount ìš°ì„  ì‚¬ìš©)
                const finalTotal = orderData.total || calculatedTotal;
                if (finalTotal > 0) {
                    orderHtml += `
                        <div class="order-total">
                            ì´ ê¸ˆì•¡: ${formatPrice(finalTotal)}
                            ${orderData.item_count ? `(${orderData.item_count}ê°œ ìƒí’ˆ)` : ''}
                        </div>
                    `;
                }
                
                // í™•ì¸ í•„ìš” í‘œì‹œ
                if (orderData.requires_confirmation) {
                    orderHtml += `
                        <div style="background: rgba(255,193,7,0.3); padding: 8px 12px; border-radius: 8px; margin-top: 8px; text-align: center;">
                            âš ï¸ ì£¼ë¬¸ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤
                        </div>
                    `;
                }
                
                orderContentEl.innerHTML = orderHtml;
                
                // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
                let timestampText = `ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString()}`;
                if (orderData.created_at) {
                    const createdTime = new Date(orderData.created_at).toLocaleTimeString();
                    timestampText += ` | ì£¼ë¬¸ì‹œê°„: ${createdTime}`;
                }
                orderTimestampEl.textContent = timestampText;
                
                // ì£¼ë¬¸ ì •ë³´ í‘œì‹œ
                orderInfoEl.style.display = 'block';
                
                addLog(`ğŸ›’ ì£¼ë¬¸ ì •ë³´ ì—…ë°ì´íŠ¸ë¨ (${orderData.items.length}ê°œ ìƒí’ˆ, ${formatPrice(finalTotal)})`, 'info');
                
            } catch (error) {
                console.error('ì£¼ë¬¸ ì •ë³´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                addLog('âŒ ì£¼ë¬¸ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        function formatPrice(price) {
            if (typeof price !== 'number') return 'ê°€ê²© ë¯¸ì •';
            return price.toLocaleString() + 'ì›';
        }
        
        function clearOrder() {
            socket.emit('clear_order');
        }
        
        function testOrder() {
            socket.emit('test_order');
            addLog('ğŸ§ª ì£¼ë¬¸ ì •ë³´ í…ŒìŠ¤íŠ¸ ìš”ì²­ ì „ì†¡', 'info');
        }
        
        // UI ì•¡ì…˜ ì²˜ë¦¬ í•¨ìˆ˜
        function processUIActions(actions) {
            try {
                console.log('ğŸ¯ UI ì•¡ì…˜ ì²˜ë¦¬ ì‹œì‘:', actions);
                
                // ìš°ì„ ìˆœìœ„ë³„ë¡œ ì •ë ¬
                actions.sort((a, b) => (b.priority || 0) - (a.priority || 0));
                
                actions.forEach((action, index) => {
                    console.log(`${index + 1}. ${action.action_type} ì²˜ë¦¬ ì¤‘...`);
                    
                    switch (action.action_type) {
                        case 'show_menu':
                            handleShowMenu(action.data);
                            break;
                        case 'show_payment':
                            handleShowPayment(action.data);
                            break;
                        case 'update_order':
                            // ì´ë¯¸ order_update ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬ë¨
                            console.log('ì£¼ë¬¸ ì—…ë°ì´íŠ¸ëŠ” ë³„ë„ ì²˜ë¦¬ë¨');
                            break;
                        case 'show_confirmation':
                            handleShowConfirmation(action.data);
                            break;
                        case 'show_error':
                            handleShowError(action.data);
                            break;
                        default:
                            console.log('ì•Œ ìˆ˜ ì—†ëŠ” ì•¡ì…˜ íƒ€ì…:', action.action_type);
                    }
                });
                
                addLog(`ğŸ¯ ${actions.length}ê°œ UI ì•¡ì…˜ ì²˜ë¦¬ ì™„ë£Œ`, 'info');
                
            } catch (error) {
                console.error('UI ì•¡ì…˜ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                addLog('âŒ UI ì•¡ì…˜ ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ë©”ë‰´ í‘œì‹œ ì²˜ë¦¬ (ì‚¬ì´ë“œë°”)
        function handleShowMenu(data) {
            try {
                console.log('ğŸ“‹ ë©”ë‰´ í‘œì‹œ:', data);
                
                const sidebarMenuContentEl = document.getElementById('sidebar-menu-content');
                const sidebarMenuTitleEl = document.getElementById('sidebar-menu-title');
                const sidebar = document.getElementById('sidebar');
                
                if (!data.menu_options || data.menu_options.length === 0) {
                    sidebarMenuContentEl.innerHTML = `
                        <div class="sidebar-menu-empty">
                            ë©”ë‰´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                            ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
                        </div>
                    `;
                    return;
                }
                
                // ë©”ë‰´ ì œëª© ì„¤ì •
                let title = 'ğŸ“‹ ë©”ë‰´';
                if (data.category) {
                    title += ` - ${data.category}`;
                }
                sidebarMenuTitleEl.textContent = title;
                
                // ë©”ë‰´ í•­ëª©ë“¤ í‘œì‹œ
                let menuHtml = '';
                data.menu_options.forEach(option => {
                    if (option.available !== false) {  // ì‚¬ìš© ê°€ëŠ¥í•œ ë©”ë‰´ë§Œ í‘œì‹œ
                        menuHtml += `
                            <div class="sidebar-menu-item" onclick="selectMenuItem('${option.option_id}')">
                                <div class="item-name">${option.display_text || option.name}</div>
                                ${option.description ? `<div class="item-description">${option.description}</div>` : ''}
                                <div class="item-footer">
                                    ${option.category ? `<div class="item-category">${option.category}</div>` : '<div></div>'}
                                    <div class="item-price">${formatPrice(option.price)}</div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                sidebarMenuContentEl.innerHTML = menuHtml;
                
                // ì‚¬ì´ë“œë°”ê°€ ë‹«í˜€ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì—´ê¸°
                if (sidebarCollapsed) {
                    toggleSidebar();
                }
                
                addLog(`ğŸ“‹ ë©”ë‰´ ì‚¬ì´ë“œë°”ì— í‘œì‹œë¨ (${data.menu_options.length}ê°œ í•­ëª©)`, 'info');
                
            } catch (error) {
                console.error('ë©”ë‰´ í‘œì‹œ ì˜¤ë¥˜:', error);
                addLog('âŒ ë©”ë‰´ í‘œì‹œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ë©”ë‰´ í•­ëª© ì„ íƒ
        function selectMenuItem(optionId) {
            console.log('ë©”ë‰´ ì„ íƒ:', optionId);
            addLog(`ğŸ” ë©”ë‰´ ì„ íƒ: ${optionId}`, 'info');
            // ì‹¤ì œë¡œëŠ” ìŒì„±ìœ¼ë¡œ í•´ë‹¹ ë©”ë‰´ë¥¼ ë§í•˜ë„ë¡ ì•ˆë‚´í•˜ê±°ë‚˜
            // ì„œë²„ì— ì„ íƒ ì •ë³´ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŒ
        }
        
        // ê²°ì œ í™”ë©´ í‘œì‹œ ì²˜ë¦¬
        function handleShowPayment(data) {
            console.log('ğŸ’³ ê²°ì œ í™”ë©´ í‘œì‹œ:', data);
            addLog('ğŸ’³ ê²°ì œ í™”ë©´ì´ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
            // ì‹¤ì œ ê²°ì œ UI êµ¬í˜„ ê°€ëŠ¥
        }
        
        // í™•ì¸ í™”ë©´ í‘œì‹œ ì²˜ë¦¬
        function handleShowConfirmation(data) {
            console.log('â“ í™•ì¸ ìš”ì²­:', data);
            addLog(`â“ í™•ì¸: ${data.message || 'í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'}`, 'warning');
        }
        
        // ì˜¤ë¥˜ í‘œì‹œ ì²˜ë¦¬
        function handleShowError(data) {
            console.log('âŒ ì˜¤ë¥˜ í‘œì‹œ:', data);
            addLog(`âŒ ì˜¤ë¥˜: ${data.error_message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'}`, 'error');
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        fetch('/config')
            .then(response => response.json())
            .then(config => {
                document.getElementById('server-url').value = config.server.url;
                addLog('í˜„ì¬ ì„¤ì • ë¡œë“œë¨', 'info');
            })
            .catch(error => {
                addLog('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            });
    </script>
</body>
</html>