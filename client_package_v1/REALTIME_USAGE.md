# 실시간 VAD 음성 클라이언트 사용법

이 문서는 **실시간 VAD(Voice Activity Detection)를 통한 음성 주문 시스템**의 완전한 사용법을 안내합니다.

## 🎯 시나리오 개요

1. **서버 측**: 메인 프로젝트가 있는 컴퓨터에서 음성 처리 서버 실행
2. **클라이언트 측**: `client_package` 디렉토리만 있는 로컬 컴퓨터에서 실시간 음성 입력
3. **자동 처리**: VAD가 음성을 감지하면 자동으로 서버에 전송하여 주문 처리

## 📋 사전 준비

### 서버 측 요구사항
- 메인 프로젝트 전체 소스코드
- Python 3.8 이상
- OpenAI API 키
- 필요한 패키지 설치 완료

### 클라이언트 측 요구사항
- `client_package` 디렉토리만 복사
- Python 3.8 이상
- 마이크 장치
- 다음 패키지들:
  ```bash
  torch>=2.0.0
  sounddevice>=0.4.6
  scipy>=1.11.3
  numpy>=1.24.0
  requests>=2.31.0
  ```

## 🚀 1단계: 서버 시작

메인 프로젝트가 있는 컴퓨터에서:

```bash
# 메인 프로젝트 디렉토리로 이동
cd /path/to/main/project

# 서버 시작 (간단한 방법)
python start_server.py

# 또는 특정 옵션으로 시작
python start_server.py --host 0.0.0.0 --port 8000 --debug
```

### 서버 설정 확인

서버가 시작되면 다음과 같은 정보가 표시됩니다:

```
🎤 음성 키오스크 API 서버
======================================================================
✅ OpenAI API 키: sk-proj12345...
🎤 TTS 설정:
   - 제공자: openai
   - 모델: tts-1
   - 음성: alloy

🚀 서버 설정:
   - 호스트: 0.0.0.0
   - 포트: 8000
   - 디버그: False

📡 서버 URL: http://0.0.0.0:8000
📊 헬스체크: http://0.0.0.0:8000/health
📁 API 문서: http://0.0.0.0:8000/docs
```

## 🎤 2단계: 클라이언트 설정

### 클라이언트 패키지 복사

서버가 실행 중인 컴퓨터에서 `client_package` 디렉토리를 클라이언트 컴퓨터로 복사합니다.

```bash
# 예: scp를 사용한 복사
scp -r /path/to/project/client_package user@client-computer:/home/user/
```

### 설정 파일 수정

클라이언트 컴퓨터에서 `client_package/config.json` 파일을 수정합니다:

```json
{
  "server": {
    "url": "http://서버IP주소:8000",
    "timeout": 30,
    "max_retries": 3,
    "retry_delay": 1
  },
  ...
}
```

예시:
```json
{
  "server": {
    "url": "http://192.168.1.100:8000",
    "timeout": 30,
    "max_retries": 3,
    "retry_delay": 1
  }
}
```

### 패키지 설치

클라이언트 컴퓨터에서:

```bash
cd client_package
pip install -r requirements.txt
```

## 🎙️ 3단계: 실시간 클라이언트 실행

### 방법 1: 간편한 실행 스크립트 사용

```bash
cd client_package
python start_realtime_client.py
```

### 방법 2: run_client.py 사용

```bash
cd client_package
python run_client.py --realtime-mic
```

### 방법 3: 완전한 예제 스크립트 사용

```bash
cd client_package
python examples/complete_realtime_client.py
```

## 📖 실제 사용 과정

### 1. 시스템 초기화

클라이언트를 실행하면 다음과 같은 과정을 거칩니다:

```
🎤 완전한 실시간 마이크 입력 클라이언트
==================================================
🏥 서버 연결 확인 중...
✅ 서버와의 연결이 정상입니다.

🧪 마이크 시스템 테스트 중...
✅ 마이크 테스트 성공!
   📊 평균 볼륨: 0.0234
   📊 최대 볼륨: 0.1567
   🎵 오디오 감지: ✅
   🗣️ VAD 음성 감지: ✅
   🎯 VAD 모드 사용 가능
```

### 2. 세션 정보 확인

```
📊 세션 정보:
   🆔 세션 ID: 12345678-1234-5678-9abc-123456789abc
   📡 서버 URL: http://192.168.1.100:8000
   ⏰ 세션 시작: 2024-01-20 15:30:45

🎤 마이크 상태:
   🔧 하드웨어: ✅
   🤖 VAD 모델: ✅
   📊 현재 볼륨: 0.0123
```

### 3. 실시간 음성 주문

```
======================================================================
🎙️ 실시간 음성 주문 시스템
======================================================================
💬 마이크에 대고 주문하세요 (예: '빅맥 세트 하나 주세요')
🔄 음성이 감지되면 자동으로 녹음하여 서버로 전송합니다
🚪 종료하려면 Ctrl+C를 누르세요
======================================================================

🎤 실시간 주문 대기 중... (VAD 모드)
⏳ 상태: waiting | 볼륨:          | VAD 모드

🗣️ 음성 감지됨! 녹음 시작...
🎙️ 상태: recording | 볼륨: ████      | VAD 모드
🔇 무음이 지속되어 녹음을 종료합니다.

🔄 음성을 처리하고 서버로 전송 중...
🎵 음성 파일 생성: realtime_mic_20240120_153045.wav
📡 서버로 음성 전송 중...

✅ 서버 응답:
   📝 응답 텍스트: 빅맥 세트 1개를 주문해드릴게요. 음료는 코카콜라로 하시겠어요?
   🛒 주문 상태: 주문_진행중
   🔊 TTS 파일: /api/voice/tts/abc123def456
   
📊 세션 통계: 1/1 성공 (100.0%)
```

## 🔧 고급 사용법

### 서버 URL 동적 변경

```bash
python start_realtime_client.py --server-url http://192.168.1.200:8000
```

### 디버그 모드 실행

```bash
python start_realtime_client.py --verbose
```

### 사용자 정의 설정 파일

```bash
python start_realtime_client.py --config my_config.json
```

## 🛠️ 문제 해결

### 1. 서버 연결 실패

```
❌ 서버에 연결할 수 없습니다: http://192.168.1.100:8000

💡 해결 방법:
   1. 서버가 실행 중인지 확인하세요
   2. config.json에서 서버 URL이 올바른지 확인하세요
   3. 네트워크 연결을 확인하세요
```

**해결책:**
- 서버 컴퓨터에서 `http://localhost:8000/health` 접속 확인
- 방화벽 설정 확인
- IP 주소와 포트 번호 재확인

### 2. 마이크 테스트 실패

```
❌ 마이크 테스트 실패:
   🔧 하드웨어 오류: 사용 가능한 마이크 장치가 없습니다

💡 해결 방법:
   1. 마이크가 연결되어 있는지 확인하세요
   2. 마이크 권한이 허용되어 있는지 확인하세요
   3. 다른 프로그램에서 마이크를 사용하고 있지 않은지 확인하세요
   4. 마이크 볼륨을 확인하세요
```

**해결책:**
- 시스템 설정에서 마이크 권한 확인
- 마이크 장치 드라이버 업데이트
- 다른 마이크 테스트 앱으로 동작 확인

### 3. VAD 모델 로드 실패

```
⚠️ VAD 폴백 모드 (볼륨 기반 감지)
```

**설명:**
- VAD 모델 로드에 실패했지만 시스템은 볼륨 기반 감지로 동작
- 인터넷 연결 문제나 torch 설치 문제일 가능성
- 기능상 문제없이 사용 가능

## 📊 성능 최적화

### 1. VAD 임계값 조정

환경이 시끄러운 경우 VAD 임계값을 높여서 오인식을 줄일 수 있습니다.

### 2. 네트워크 최적화

- 서버와 클라이언트를 같은 네트워크에 연결
- 유선 연결 사용 권장
- QoS 설정으로 오디오 트래픽 우선순위 부여

### 3. 오디오 품질 설정

더 높은 음질이 필요한 경우 샘플레이트를 조정할 수 있습니다.

## 🔍 세션 통계

시스템은 실시간으로 다음 통계를 제공합니다:

- **총 요청 수**: 서버로 전송한 음성 파일 개수
- **성공 요청**: 정상적으로 처리된 요청 수
- **실패 요청**: 오류가 발생한 요청 수
- **성공률**: 전체 성공률 퍼센티지
- **세션 시간**: 총 사용 시간

## 📝 주요 특징 요약

✅ **자동 음성 감지**: VAD를 통한 정확한 음성/무음 구분  
✅ **즉시 전송**: 음성 감지 완료 즉시 서버로 자동 전송  
✅ **연속 처리**: 한 번 실행으로 여러 번의 주문 처리  
✅ **폴백 모드**: VAD 실패 시 볼륨 기반 감지로 자동 전환  
✅ **실시간 피드백**: 음성 감지, 전송, 응답 상태를 실시간 표시  
✅ **오류 복구**: 네트워크 오류, 서버 오류 시 자동 재시도  
✅ **세션 관리**: 세션별 통계 및 상태 추적  

이제 완전한 실시간 VAD 음성 주문 시스템을 사용할 수 있습니다! 🎉