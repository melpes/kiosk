<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ìŒì„± í´ë¼ì´ì–¸íŠ¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            gap: 20px;
        }
        
        .container {
            flex: 1;
            max-width: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            transition: transform 0.3s ease;
            transform: translateX(100%);
        }
        
        .sidebar.collapsed {
            transform: translateX(100%);
        }
        
        .sidebar:not(.collapsed) {
            transform: translateX(0);
        }
        
        .sidebar-header {
            background: #e74c3c;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .sidebar-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 16px;
            padding: 8px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sidebar-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .sidebar-content {
            padding: 20px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }
        
        .sidebar-menu {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .sidebar-menu h3 {
            margin: 0;
            padding: 15px;
            font-size: 16px;
            text-align: center;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
        }
        
        .sidebar-menu-content {
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .sidebar-menu-item {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sidebar-menu-item:hover {
            background: rgba(255,255,255,0.25);
            transform: translateX(3px);
        }
        
        .sidebar-menu-item .item-name {
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .sidebar-menu-item .item-description {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 6px;
        }
        
        .sidebar-menu-item .item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-menu-item .item-category {
            background: rgba(255,255,255,0.3);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
        }
        
        .sidebar-menu-item .item-price {
            font-weight: bold;
            font-size: 14px;
        }
        
        .sidebar-menu-empty {
            padding: 20px;
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-style: italic;
        }
        
        .sidebar-menu-toggle-btn {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 8px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            font-size: 18px;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
        }
        
        .sidebar-menu-toggle-btn:hover {
            background: #c0392b;
            transform: translateY(-50%) translateX(-5px);
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .menu-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 20px;
            padding: 10px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .menu-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .collapsible-section {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .collapsible-section.collapsed {
            max-height: 0;
            padding: 0 20px;
            border-top: none;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 1px solid #eee;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        
        .section-header:hover {
            background: #e9ecef;
        }
        
        .section-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        
        .section-arrow {
            font-size: 18px;
            transition: transform 0.3s ease;
        }
        
        .section-arrow.collapsed {
            transform: rotate(-90deg);
        }
        
        .header h1 {
            margin-bottom: 10px;
        }
        
        .status {
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .controls {
            padding: 20px;
            text-align: center;
        }
        
        .btn {
            padding: 12px 30px;
            margin: 10px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-start {
            background: #28a745;
            color: white;
        }
        
        .btn-start:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-stop {
            background: #dc3545;
            color: white;
        }
        
        .btn-stop:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .config-section {
            padding: 20px;
            border-top: 1px solid #eee;
        }
        
        .config-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .config-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .log-section {
            padding: 20px;
            border-top: 1px solid #eee;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .log-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .log-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .log-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .log-transcription {
            background: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        
        .log-response {
            background: #cce5ff;
            color: #004085;
            font-weight: bold;
        }
        
        .log-audio {
            background: #e2e3e5;
            color: #383d41;
            font-weight: bold;
        }
        
        .log-server {
            background: #fff3cd;
            color: #856404;
        }
        
        .indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .indicator.green {
            background: #28a745;
        }
        
        .indicator.red {
            background: #dc3545;
        }
        
        .audio-player {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .audio-player audio {
            width: 100%;
            margin-top: 5px;
        }
        
        .server-info {
            padding: 15px;
            margin: 20px;
            background: #e9ecef;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .server-info h4 {
            margin-bottom: 10px;
            color: #495057;
        }
        
        .info-item {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .info-label {
            font-weight: bold;
            color: #6c757d;
        }
        
        .processing-indicator {
            display: none;
            padding: 10px;
            margin: 10px 20px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            text-align: center;
        }
        
        .processing-indicator.active {
            display: block;
        }
        
        .confidence-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- ì‚¬ì´ë“œë°” í† ê¸€ ë²„íŠ¼ -->
    <button class="sidebar-menu-toggle-btn" onclick="toggleSidebar()" title="ë©”ë‰´ ì‚¬ì´ë“œë°” í† ê¸€">
        ğŸ“–
    </button>
    
    <div class="container">
        <div class="header">
            <button class="menu-toggle" onclick="toggleAllSections()" title="ë©”ë‰´ í† ê¸€">
                â˜°
            </button>
            <h1>ğŸ¤ ì‹¤ì‹œê°„ ìŒì„± í´ë¼ì´ì–¸íŠ¸</h1>
            <p>ì›¹ ê¸°ë°˜ ìŒì„± ì¸ì‹ ë° ì‘ë‹µ ì‹œìŠ¤í…œ</p>
        </div>
        
        <div id="status" class="status disconnected">
            <span class="indicator red"></span>
            <span id="status-text">ì—°ê²° ì¤‘...</span>
        </div>
        
        <div id="processing-indicator" class="processing-indicator">
            <span>ğŸ¤ ìŒì„± ì²˜ë¦¬ ì¤‘...</span>
        </div>
        
        <div id="server-info" class="server-info" style="display: none;">
            <h4>ğŸ“¡ ì„œë²„ ì •ë³´</h4>
            <div class="info-item">
                <span class="info-label">ì„œë²„ URL:</span>
                <span id="server-url-display">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">ì—°ê²° ìƒíƒœ:</span>
                <span id="server-connection-status">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">ë§ˆì§€ë§‰ ì‘ë‹µ:</span>
                <span id="last-response-time">-</span>
            </div>
        </div>
        
        <div class="controls">
            <button id="start-btn" class="btn btn-start" onclick="startSession()">
                ğŸš€ ì„¸ì…˜ ì‹œì‘
            </button>
            <button id="stop-btn" class="btn btn-stop" onclick="stopSession()" disabled>
                â¹ï¸ ì„¸ì…˜ ì¤‘ì§€
            </button>
        </div>
        
        <div class="section-header" onclick="toggleSection('config-section')">
            <h3>âš™ï¸ ì„œë²„ ì„¤ì •</h3>
            <span class="section-arrow">â–¼</span>
        </div>
        <div id="config-section" class="config-section collapsible-section">
            <input type="text" id="server-url" class="config-input" placeholder="ì„œë²„ URL (ì˜ˆ: http://localhost:8001)">
            <button class="btn" onclick="updateConfig()" style="background: #007bff; color: white;">
                ì„¤ì • ì €ì¥
            </button>
            <button class="btn" onclick="testTTS()" style="background: #28a745; color: white;">
                ğŸ”Š TTS í…ŒìŠ¤íŠ¸
            </button>
        </div>
        
        <div class="section-header" onclick="toggleSection('log-section')">
            <h3>ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
            <span class="section-arrow">â–¼</span>
        </div>
        <div id="log-section" class="log-section collapsible-section">
            <div id="logs"></div>
        </div>
    </div>
    
    <!-- ë©”ë‰´ ì‚¬ì´ë“œë°” -->
    <div id="sidebar" class="sidebar collapsed">
        <div class="sidebar-header">
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="ì‚¬ì´ë“œë°” ë‹«ê¸°">
                âœ•
            </button>
            <h2>ğŸ½ï¸ ì‹ë‹¹ ë©”ë‰´</h2>
            <p>ë§›ìˆëŠ” ìŒì‹ì„ ì„ íƒí•˜ì„¸ìš”</p>
        </div>
        <div class="sidebar-content">
            <div id="sidebar-menu" class="sidebar-menu">
                <h3 id="sidebar-menu-title">ğŸ“‹ ë©”ë‰´</h3>
                <div id="sidebar-menu-content" class="sidebar-menu-content">
                    <div class="sidebar-menu-empty">
                        ì•„ì§ ë©”ë‰´ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>
                        ìŒì„±ìœ¼ë¡œ ë©”ë‰´ë¥¼ ìš”ì²­í•´ë³´ì„¸ìš”!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì›¹ì†Œì¼“ ì—°ê²° ì„¤ì •
        const socket = io({
            transports: ['websocket', 'polling'],
            timeout: 5000,
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5
        });
        
        let isRunning = false;
        let socketConnected = false;
        let connectionTimeout = null;
        
        // ì†Œì¼“ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        socket.on('connect', function() {
            console.log('âœ… ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ');
            socketConnected = true;
            clearTimeout(connectionTimeout);
            addLog('âœ… ì›¹ì†Œì¼“ ì—°ê²°ë¨', 'info');
            
            // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
            updateConnectionStatus(true);
            
            // ì„¤ì • ë¡œë“œ
            setTimeout(loadConfig, 100);
        });
        
        socket.on('disconnect', function(reason) {
            console.log('âŒ ì›¹ì†Œì¼“ ì—°ê²° í•´ì œ:', reason);
            socketConnected = false;
            addLog('âŒ ì›¹ì†Œì¼“ ì—°ê²° í•´ì œë¨: ' + reason, 'error');
            
            // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
            updateConnectionStatus(false);
        });
        
        socket.on('connect_error', function(error) {
            console.error('âŒ ì›¹ì†Œì¼“ ì—°ê²° ì˜¤ë¥˜:', error);
            socketConnected = false;
            addLog('âŒ ì›¹ì†Œì¼“ ì—°ê²° ì‹¤íŒ¨: ' + error.message, 'error');
            
            // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
            updateConnectionStatus(false);
        });
        
        socket.on('reconnect', function(attemptNumber) {
            console.log('ğŸ”„ ì›¹ì†Œì¼“ ì¬ì—°ê²° ì„±ê³µ:', attemptNumber);
            addLog('ğŸ”„ ì›¹ì†Œì¼“ ì¬ì—°ê²°ë¨', 'info');
        });
        
        socket.on('reconnect_error', function(error) {
            console.error('âŒ ì›¹ì†Œì¼“ ì¬ì—°ê²° ì‹¤íŒ¨:', error);
            addLog('âŒ ì›¹ì†Œì¼“ ì¬ì—°ê²° ì‹¤íŒ¨', 'error');
        });
        
        socket.on('status', function(data) {
            updateStatus(data.message, data.running);
            addLog(data.message, 'info');
        });
        
        socket.on('error', function(data) {
            addLog('âŒ ' + data.message, 'error');
            updateButtons(false);
        });
        
        socket.on('warning', function(data) {
            addLog('âš ï¸ ' + data.message, 'warning');
        });
        
        socket.on('transcription', function(data) {
            let logText = 'ğŸ¯ ì¸ì‹: ' + data.text;
            if (data.confidence) {
                logText += ` (ì‹ ë¢°ë„: ${(data.confidence * 100).toFixed(1)}%)`;
            }
            addLog(logText, 'transcription');
            
            // ì‹ ë¢°ë„ ë°” í‘œì‹œ
            if (data.confidence) {
                addConfidenceBar(data.confidence);
            }
        });
        
        socket.on('response', function(data) {
            let responseText = data.text || JSON.stringify(data);
            addLog('ğŸ’¬ ì‘ë‹µ: ' + responseText, 'response');
            updateLastResponseTime();
            
            // UI ì•¡ì…˜ ì²˜ë¦¬
            if (data.ui_actions && data.ui_actions.length > 0) {
                processUIActions(data.ui_actions);
            }
        });
        
        socket.on('ui_actions', function(data) {
            console.log('ğŸ¯ UI ì•¡ì…˜ ìˆ˜ì‹ :', data);
            processUIActions(data);
        });
        
        socket.on('audio', function(data) {
            addLog('ğŸ”Š TTS ì˜¤ë””ì˜¤ ìˆ˜ì‹ ', 'audio');
            playTTSAudio(data);
        });
        
        socket.on('server_info', function(data) {
            updateServerInfo(data);
        });
        
        socket.on('processing_status', function(data) {
            updateProcessingStatus(data);
        });
        
        // ë©”ë‰´ í† ê¸€ í•¨ìˆ˜ë“¤
        let allSectionsCollapsed = false;
        let sidebarCollapsed = true;
        
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const arrow = section.previousElementSibling.querySelector('.section-arrow');
            
            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                arrow.classList.remove('collapsed');
                arrow.textContent = 'â–¼';
            } else {
                section.classList.add('collapsed');
                arrow.classList.add('collapsed');
                arrow.textContent = 'â–¶';
            }
        }
        
        function toggleAllSections() {
            const sections = ['config-section', 'log-section'];
            const menuToggle = document.querySelector('.menu-toggle');
            
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                const arrow = section.previousElementSibling.querySelector('.section-arrow');
                
                if (allSectionsCollapsed) {
                    section.classList.remove('collapsed');
                    arrow.classList.remove('collapsed');
                    arrow.textContent = 'â–¼';
                } else {
                    section.classList.add('collapsed');
                    arrow.classList.add('collapsed');
                    arrow.textContent = 'â–¶';
                }
            });
            
            allSectionsCollapsed = !allSectionsCollapsed;
            menuToggle.textContent = allSectionsCollapsed ? 'â˜±' : 'â˜°';
        }
        
        // ì‚¬ì´ë“œë°” í† ê¸€ í•¨ìˆ˜
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.querySelector('.sidebar-menu-toggle-btn');
            
            if (sidebarCollapsed) {
                sidebar.classList.remove('collapsed');
                toggleBtn.textContent = 'ğŸ“‹';
                sidebarCollapsed = false;
            } else {
                sidebar.classList.add('collapsed');
                toggleBtn.textContent = 'ğŸ“–';
                sidebarCollapsed = true;
            }
        }
        
        // ë©”ë‰´ í‘œì‹œ ì²˜ë¦¬ (ì‚¬ì´ë“œë°”)
        function handleShowMenu(data) {
            try {
                console.log('ğŸ“‹ ë©”ë‰´ í‘œì‹œ:', data);
                
                const sidebarMenuContentEl = document.getElementById('sidebar-menu-content');
                const sidebarMenuTitleEl = document.getElementById('sidebar-menu-title');
                const sidebar = document.getElementById('sidebar');
                
                if (!data.menu_options || data.menu_options.length === 0) {
                    sidebarMenuContentEl.innerHTML = `
                        <div class="sidebar-menu-empty">
                            ë©”ë‰´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                            ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
                        </div>
                    `;
                    return;
                }
                
                // ë©”ë‰´ ì œëª© ì„¤ì •
                let title = 'ğŸ“‹ ë©”ë‰´';
                if (data.category) {
                    title += ` - ${data.category}`;
                }
                sidebarMenuTitleEl.textContent = title;
                
                // ë©”ë‰´ í•­ëª©ë“¤ í‘œì‹œ
                let menuHtml = '';
                data.menu_options.forEach(option => {
                    if (option.available !== false) {  // ì‚¬ìš© ê°€ëŠ¥í•œ ë©”ë‰´ë§Œ í‘œì‹œ
                        menuHtml += `
                            <div class="sidebar-menu-item" onclick="selectMenuItem('${option.option_id}')">
                                <div class="item-name">${option.display_text || option.name}</div>
                                ${option.description ? `<div class="item-description">${option.description}</div>` : ''}
                                <div class="item-footer">
                                    ${option.category ? `<div class="item-category">${option.category}</div>` : '<div></div>'}
                                    <div class="item-price">${formatPrice(option.price)}</div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                sidebarMenuContentEl.innerHTML = menuHtml;
                
                // ì‚¬ì´ë“œë°”ê°€ ë‹«í˜€ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì—´ê¸°
                if (sidebarCollapsed) {
                    toggleSidebar();
                }
                
                addLog(`ğŸ“‹ ë©”ë‰´ ì‚¬ì´ë“œë°”ì— í‘œì‹œë¨ (${data.menu_options.length}ê°œ í•­ëª©)`, 'info');
                
            } catch (error) {
                console.error('ë©”ë‰´ í‘œì‹œ ì˜¤ë¥˜:', error);
                addLog('âŒ ë©”ë‰´ í‘œì‹œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ë©”ë‰´ í•­ëª© ì„ íƒ
        function selectMenuItem(optionId) {
            console.log('ë©”ë‰´ ì„ íƒ:', optionId);
            addLog(`ğŸ” ë©”ë‰´ ì„ íƒ: ${optionId}`, 'info');
            // ì‹¤ì œë¡œëŠ” ìŒì„±ìœ¼ë¡œ í•´ë‹¹ ë©”ë‰´ë¥¼ ë§í•˜ë„ë¡ ì•ˆë‚´í•˜ê±°ë‚˜
            // ì„œë²„ì— ì„ íƒ ì •ë³´ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŒ
        }
        
        // ê°€ê²© í¬ë§·íŒ… í•¨ìˆ˜
        function formatPrice(price) {
            if (typeof price !== 'number') return 'ê°€ê²© ë¯¸ì •';
            return price.toLocaleString() + 'ì›';
        }
        
        // UI ì•¡ì…˜ ì²˜ë¦¬ í•¨ìˆ˜
        function processUIActions(actions) {
            try {
                console.log('ğŸ¯ UI ì•¡ì…˜ ì²˜ë¦¬ ì‹œì‘:', actions);
                
                // ìš°ì„ ìˆœìœ„ë³„ë¡œ ì •ë ¬
                actions.sort((a, b) => (b.priority || 0) - (a.priority || 0));
                
                actions.forEach((action, index) => {
                    console.log(`${index + 1}. ${action.action_type} ì²˜ë¦¬ ì¤‘...`);
                    
                    switch (action.action_type) {
                        case 'show_menu':
                            handleShowMenu(action.data);
                            break;
                        case 'show_payment':
                            console.log('ğŸ’³ ê²°ì œ í™”ë©´ í‘œì‹œ:', action.data);
                            addLog('ğŸ’³ ê²°ì œ í™”ë©´ì´ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
                            break;
                        case 'show_confirmation':
                            console.log('â“ í™•ì¸ ìš”ì²­:', action.data);
                            addLog(`â“ í™•ì¸: ${action.data.message || 'í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'}`, 'warning');
                            break;
                        case 'show_error':
                            console.log('âŒ ì˜¤ë¥˜ í‘œì‹œ:', action.data);
                            addLog(`âŒ ì˜¤ë¥˜: ${action.data.error_message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'}`, 'error');
                            break;
                        default:
                            console.log('ì•Œ ìˆ˜ ì—†ëŠ” ì•¡ì…˜ íƒ€ì…:', action.action_type);
                    }
                });
                
                addLog(`ğŸ¯ ${actions.length}ê°œ UI ì•¡ì…˜ ì²˜ë¦¬ ì™„ë£Œ`, 'info');
                
            } catch (error) {
                console.error('UI ì•¡ì…˜ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                addLog('âŒ UI ì•¡ì…˜ ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ì„¤ì • ë¡œë“œ í•¨ìˆ˜
        function loadConfig() {
            fetch('/config')
                .then(response => response.json())
                .then(config => {
                    document.getElementById('server-url').value = config.server.url;
                    addLog('í˜„ì¬ ì„¤ì • ë¡œë“œë¨', 'info');
                })
                .catch(error => {
                    addLog('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
                });
        }
        
        // í•¨ìˆ˜ë“¤
        function startSession() {
            socket.emit('start_session');
            updateButtons(true);
            addLog('ì„¸ì…˜ ì‹œì‘ ìš”ì²­...', 'info');
        }
        
        function stopSession() {
            socket.emit('stop_session');
            updateButtons(false);
            addLog('ì„¸ì…˜ ì¤‘ì§€ ìš”ì²­...', 'info');
        }
        
        function updateStatus(message, running) {
            const statusEl = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            const indicator = statusEl.querySelector('.indicator');
            
            statusText.textContent = message;
            isRunning = running;
            
            if (running) {
                statusEl.className = 'status connected';
                indicator.className = 'indicator green';
            } else {
                statusEl.className = 'status disconnected';
                indicator.className = 'indicator red';
            }
            
            updateButtons(running);
        }
        
        function updateButtons(running) {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            
            startBtn.disabled = running;
            stopBtn.disabled = !running;
        }
        
        function addLog(message, type) {
            const logsEl = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            logsEl.appendChild(logEntry);
            logsEl.scrollTop = logsEl.scrollHeight;
            
            // ë¡œê·¸ ê°œìˆ˜ ì œí•œ (ìµœëŒ€ 100ê°œ)
            while (logsEl.children.length > 100) {
                logsEl.removeChild(logsEl.firstChild);
            }
        }
        
        function updateConfig() {
            const serverUrl = document.getElementById('server-url').value;
            if (!serverUrl) {
                addLog('ì„œë²„ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            fetch('/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    server: { url: serverUrl }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
                } else {
                    addLog('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + data.message, 'error');
                }
            })
            .catch(error => {
                addLog('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + error, 'error');
            });
        }
        
        function playTTSAudio(audioData) {
            try {
                console.log('TTS ì˜¤ë””ì˜¤ ë°ì´í„°:', audioData);
                
                const audioPlayer = document.createElement('div');
                audioPlayer.className = 'audio-player';
                
                // í…ŒìŠ¤íŠ¸ ì—¬ë¶€ í™•ì¸
                const testLabel = audioData.test ? ' (í…ŒìŠ¤íŠ¸)' : '';
                
                audioPlayer.innerHTML = `
                    <div>ğŸ”Š TTS ìŒì„±${testLabel} (${new Date().toLocaleTimeString()})</div>
                    <div style="font-size: 12px; color: #6c757d;">
                        íŒŒì¼: ${audioData.filename || audioData.path} 
                        ${audioData.size ? `(${Math.round(audioData.size/1024)}KB)` : ''}
                    </div>
                    <audio controls preload="auto" style="width: 100%; margin-top: 5px;">
                        <source src="${audioData.url}" type="audio/wav">
                        <source src="${audioData.url}" type="audio/mpeg">
                        <source src="${audioData.url}" type="audio/mp3">
                        ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </audio>
                    <div style="margin-top: 5px;">
                        <button onclick="playAudio(this)" style="padding: 5px 10px; margin-right: 5px;">â–¶ï¸ ì¬ìƒ</button>
                        <button onclick="downloadAudio('${audioData.url}', '${audioData.filename || 'audio.wav}')" 
                                style="padding: 5px 10px;">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                `;
                
                const logsEl = document.getElementById('logs');
                logsEl.appendChild(audioPlayer);
                logsEl.scrollTop = logsEl.scrollHeight;
                
                // ì˜¤ë””ì˜¤ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
                const audio = audioPlayer.querySelector('audio');
                
                // ì˜¤ë””ì˜¤ ë¡œë“œ ì´ë²¤íŠ¸
                audio.addEventListener('loadstart', function() {
                    console.log('ì˜¤ë””ì˜¤ ë¡œë“œ ì‹œì‘:', audioData.url);
                });
                
                audio.addEventListener('canplay', function() {
                    console.log('ì˜¤ë””ì˜¤ ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ');
                    addLog('ğŸ”Š TTS ì˜¤ë””ì˜¤ ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ', 'info');
                    
                    // ìë™ ì¬ìƒ ì‹œë„ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ì—ë§Œ ê°€ëŠ¥)
                    if (!audioData.test) {
                        tryAutoPlay(audio);
                    }
                });
                
                audio.addEventListener('error', function(e) {
                    console.error('ì˜¤ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜:', e);
                    addLog('âŒ ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨: ' + audioData.url, 'error');
                });
                
                audio.addEventListener('play', function() {
                    addLog('â–¶ï¸ TTS ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œì‘', 'info');
                });
                
                audio.addEventListener('ended', function() {
                    addLog('â¹ï¸ TTS ì˜¤ë””ì˜¤ ì¬ìƒ ì™„ë£Œ', 'info');
                });
                
                // ì˜¤ë””ì˜¤ ë¡œë“œ ì‹œì‘
                audio.load();
                
            } catch (error) {
                console.error('TTS ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:', error);
                addLog('âŒ TTS ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }
        
        function tryAutoPlay(audio) {
            // ìë™ ì¬ìƒ ì‹œë„ (ë¸Œë¼ìš°ì € ì •ì±…ì— ë”°ë¼ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ)
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('ìë™ ì¬ìƒ ì„±ê³µ');
                }).catch(error => {
                    console.log('ìë™ ì¬ìƒ ì‹¤íŒ¨ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í•„ìš”):', error);
                    addLog('ğŸ”‡ ìë™ ì¬ìƒ ì‹¤íŒ¨ - ìˆ˜ë™ìœ¼ë¡œ ì¬ìƒ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', 'warning');
                });
            }
        }
        
        function playAudio(button) {
            const audioPlayer = button.closest('.audio-player');
            const audio = audioPlayer.querySelector('audio');
            
            if (audio.paused) {
                audio.play().then(() => {
                    button.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
                }).catch(error => {
                    addLog('ì¬ìƒ ì‹¤íŒ¨: ' + error.message, 'error');
                });
            } else {
                audio.pause();
                button.textContent = 'â–¶ï¸ ì¬ìƒ';
            }
        }
        
        function downloadAudio(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            addLog('ğŸ’¾ ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ: ' + filename, 'info');
        }
        
        function testTTS() {
            socket.emit('test_tts');
            addLog('ğŸ§ª TTS í…ŒìŠ¤íŠ¸ ìš”ì²­ ì „ì†¡', 'info');
        }
        
        function updateServerInfo(data) {
            const serverInfoEl = document.getElementById('server-info');
            const serverUrlEl = document.getElementById('server-url-display');
            const connectionStatusEl = document.getElementById('server-connection-status');
            
            serverInfoEl.style.display = 'block';
            serverUrlEl.textContent = data.server_url || '-';
            connectionStatusEl.textContent = data.connected ? 'âœ… ì—°ê²°ë¨' : 'âŒ ì—°ê²° ì•ˆë¨';
            connectionStatusEl.style.color = data.connected ? '#28a745' : '#dc3545';
        }
        
        function updateProcessingStatus(data) {
            const processingEl = document.getElementById('processing-indicator');
            if (data.processing) {
                processingEl.classList.add('active');
                processingEl.innerHTML = `<span>ğŸ¤ ${data.message || 'ìŒì„± ì²˜ë¦¬ ì¤‘...'}</span>`;
            } else {
                processingEl.classList.remove('active');
            }
        }
        
        function updateLastResponseTime() {
            const lastResponseEl = document.getElementById('last-response-time');
            lastResponseEl.textContent = new Date().toLocaleTimeString();
        }
        
        function addConfidenceBar(confidence) {
            const logsEl = document.getElementById('logs');
            const confidenceBar = document.createElement('div');
            confidenceBar.className = 'log-entry';
            confidenceBar.innerHTML = `
                <div>ì‹ ë¢°ë„: ${(confidence * 100).toFixed(1)}%</div>
                <div class="confidence-bar">
                    <div class="confidence-fill" style="width: ${confidence * 100}%"></div>
                </div>
            `;
            logsEl.appendChild(confidenceBar);
            logsEl.scrollTop = logsEl.scrollHeight;
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            const indicator = statusEl.querySelector('.indicator');
            
            if (connected) {
                statusEl.className = 'status connected';
                indicator.className = 'indicator green';
                statusText.textContent = 'ì›¹ì†Œì¼“ ì—°ê²°ë¨';
            } else {
                statusEl.className = 'status disconnected';
                indicator.className = 'indicator red';
                statusText.textContent = 'ì—°ê²° ì¤‘...';
                
                // ì¬ì—°ê²° ì‹œë„
                setTimeout(() => {
                    if (!socketConnected) {
                        addLog('ğŸ”„ ì¬ì—°ê²° ì‹œë„ ì¤‘...', 'info');
                    }
                }, 2000);
            }
        }
        
        function checkServerStatus() {
            if (!socketConnected) {
                console.log('ì›¹ì†Œì¼“ ì—°ê²°ë˜ì§€ ì•ŠìŒ - ì„œë²„ ìƒíƒœ í™•ì¸ ê±´ë„ˆëœ€');
                return;
            }
            
            fetch('/server-status')
                .then(response => response.json())
                .then(data => {
                    updateServerInfo(data);
                })
                .catch(error => {
                    console.error('ì„œë²„ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        function initializePage() {
            console.log('ğŸ“± í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            
            // ì—°ê²° íƒ€ì„ì•„ì›ƒ ì„¤ì •
            connectionTimeout = setTimeout(() => {
                if (!socketConnected) {
                    console.warn('âš ï¸ ì›¹ì†Œì¼“ ì—°ê²° ì‹œê°„ ì´ˆê³¼');
                    addLog('âš ï¸ ì›¹ì†Œì¼“ ì—°ê²° ì‹œê°„ ì´ˆê³¼ - í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”', 'warning');
                    updateConnectionStatus(false);
                }
            }, 10000); // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
            
            // ì›¹ì†Œì¼“ì´ ì—°ê²°ë˜ì§€ ì•Šì€ ê²½ìš° ì„¤ì •ë§Œ ë¨¼ì € ë¡œë“œ
            if (!socketConnected) {
                setTimeout(() => {
                    if (!socketConnected) {
                        console.log('ì›¹ì†Œì¼“ ì—°ê²° ëŒ€ê¸° ì¤‘... ì„¤ì • ë¨¼ì € ë¡œë“œ');
                        loadConfig();
                    }
                }, 2000);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“± DOM ë¡œë“œ ì™„ë£Œ');
            initializePage();
        });
        
        // ì£¼ê¸°ì ìœ¼ë¡œ ì„œë²„ ìƒíƒœ í™•ì¸ (ì›¹ì†Œì¼“ ì—°ê²°ëœ ê²½ìš°ë§Œ)
        setInterval(() => {
            if (socketConnected) {
                checkServerStatus();
            }
        }, 10000); // 10ì´ˆë§ˆë‹¤
    </script>
</body>
</html>